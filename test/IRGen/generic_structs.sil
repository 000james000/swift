// RUN: %swift -triple x86_64-apple-darwin10 %s -emit-llvm -enable-dynamic-value-type-layout | FileCheck %s

import Builtin

// CHECK-NOT: @_TWVV15generic_structs13SingleDynamic

// CHECK: @_TMPdV15generic_structs13SingleDynamic = global {{[{].*\* [}]}} {
// -- template header
// CHECK:   void (i8*, i8*)* [[SINGLE_DYNAMIC_FILL_METADATA:@fill_generic_metadata[0-9]*]],
// CHECK:   i32 168, i16 1, i16 8, [8 x i8*] zeroinitializer,
// -- placeholder for vwtable pointer
// CHECK:   i8* null,
// -- address point
// CHECK:   i64 1, i8* null, %swift.type* null, %swift.type* null,
// -- tail-allocated vwtable pattern
// CHECK:   i8* bitcast (void ([24 x i8]*, %swift.type*)* @_TwXXV15generic_structs13SingleDynamic to i8*),
// -- ...
// -- placeholder for size, flags, stride
// CHECK:   i8* null, i8* null, i8* null }

// CHECK-NOT: @_TWVV15generic_structs13SingleDynamic

// CHECK: define linkonce_odr hidden void @_TwXXV15generic_structs13SingleDynamic([24 x i8]* %buffer, %swift.type* %Self) {
// CHECK:   [[SELF_ARRAY:%.*]] = bitcast %swift.type* %Self to %swift.type**
// CHECK:   [[SELF_T_ADDR:%.*]] = getelementptr inbounds %swift.type** [[SELF_ARRAY]], i64 3
// CHECK:   %T = load %swift.type** [[SELF_T_ADDR]], align 8

struct SingleDynamic<T> {
  var x : T
}

sil @top_level_code : $() -> () {
entry:
  %0 = tuple ()
  return %0 : $()
}

// CHECK: define internal void [[SINGLE_DYNAMIC_FILL_METADATA]](i8*, i8*) {
// CHECK: entry:
// CHECK:   [[METADATA_ADDR:%.*]] = bitcast i8* %0 to i64*
// CHECK:   [[ARGS_ADDR:%.*]] = bitcast i8* %1 to i64*
// -- fill ops
// CHECK:   [[METADATA_SLOT_ADDR:%.*]] = getelementptr inbounds i64* [[METADATA_ADDR]], i32 4
// CHECK:   [[ARGS_SLOT_ADDR:%.*]] = getelementptr inbounds i64* [[ARGS_ADDR]], i32 0
// CHECK:   [[ARG:%.*]] = load i64* [[ARGS_SLOT_ADDR]], align 8
// CHECK:   store i64 [[ARG]], i64* [[METADATA_SLOT_ADDR]], align 8
// -- store vwtable reference
// CHECK:   [[VWTABLE_ADDR:%.*]] = getelementptr inbounds i64* [[METADATA_ADDR]], i32 5
// CHECK:   [[VWTABLE_VAL:%.*]] = ptrtoint i64* [[VWTABLE_ADDR]] to i64
// CHECK:   [[VWTABLE_SLOT_ADDR:%.*]] = getelementptr inbounds i64* [[METADATA_ADDR]], i32 0
// CHECK:   store i64 [[VWTABLE_VAL]], i64* [[VWTABLE_SLOT_ADDR]], align 8
// CHECK:   ret void
// CHECK: }

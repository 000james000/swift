// RUN: %swift -target x86_64-apple-darwin10 %s -emit-ir | FileCheck %s

import Builtin
import Swift

// CHECK: [[OBJC:%objc_object]] = type

class C {}
sil @_TFC11autorelease1Cd : $@cc(method) @thin (@owned C) -> @owned Builtin.ObjectPointer {
bb0(%0 : $C):
  %1 = ref_to_object_pointer %0 : $C to $Builtin.ObjectPointer // user: %2
  return %1 : $Builtin.ObjectPointer              // id: %2
}

sil @foo : $@thin (@owned C?) -> @autoreleased C? {
bb0(%0 : $C?):
  autorelease_return %0 : $C?
}
// CHECK:    define i64 @foo(i64) {
// CHECK:      [[T0:%.*]] = tail call i64 bitcast ([[OBJC]]* ([[OBJC]]*)* @objc_autoreleaseReturnValue to i64 (i64)*)(i64 %0)
// CHECK-NEXT: ret i64 [[T0]]

sil @bar : $@thin (@owned C?) -> @owned C? {
bb0(%0 : $C?):
  %1 = function_ref @foo : $@thin (@owned C?) -> @autoreleased C?
  %2 = apply %1(%0) : $@thin (@owned C?) -> @autoreleased C?
  strong_retain_autoreleased %2 : $C?
  return %2 : $C?
}
// CHECK:    define i64 @bar(i64)
// CHECK:      [[T0:%.*]] = call i64 @foo(i64 %0)
// CHECK-NEXT: [[T1:%.*]] = call i64 bitcast ([[OBJC]]* ([[OBJC]]*)* @objc_retainAutoreleasedReturnValue to i64 (i64)*)(i64 [[T0]])
// CHECK-NEXT: ret i64 [[T1]]
